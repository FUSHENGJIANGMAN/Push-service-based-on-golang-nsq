<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>åŠ¨æ€æ¶ˆæ¯æ”¶ä»¶ç®±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        body {
            margin: 0;
            background: #0b1020;
            color: #e8ecff;
            overflow: hidden;
            /* å®Œå…¨ç¦æ­¢é¡µé¢çº§åˆ«çš„æ»šåŠ¨ */
            height: 100vh;
            /* é™åˆ¶é¡µé¢é«˜åº¦ */
        }

        .wrap {
            width: 100%;
            margin: 24px 0;
            padding: 0 16px;
            box-sizing: border-box;
            height: calc(100vh - 48px);
            /* å‡å»ä¸Šä¸‹marginçš„é«˜åº¦ */
            overflow: hidden;
            /* ç¡®ä¿wrapå®¹å™¨å†…å®¹ä¸ä¼šæº¢å‡º */
        }

        .main-container {
            display: flex;
            gap: 20px;
            height: calc(100% - 100px);
            /* ä¸ºheaderå’Œå…¶ä»–å…ƒç´ ç•™å‡ºç©ºé—´ */
            min-height: 500px;
        }

        .sidebar {
            width: 250px;
            flex-shrink: 0;
            background: linear-gradient(180deg, rgba(20, 30, 70, .3), rgba(10, 15, 35, .4));
            border: 1px solid #24315f;
            border-radius: 14px;
            padding: 16px;
            height: 100%;
            /* å æ»¡å®¹å™¨é«˜åº¦ */
            max-height: 100%;
            overflow-y: auto;
            /* åªå…è®¸å‚ç›´æ»šåŠ¨ */
            overflow-x: hidden;
            /* ç¦æ­¢æ°´å¹³æ»šåŠ¨ */
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .table-wrapper::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .cell-json::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track,
        .cell-json::-webkit-scrollbar-track {
            background: rgba(20, 30, 70, 0.3);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .cell-json::-webkit-scrollbar-thumb {
            background: #24315f;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover,
        .cell-json::-webkit-scrollbar-thumb:hover {
            background: #34426f;
        }

        .table-wrapper::-webkit-scrollbar-corner {
            background: rgba(20, 30, 70, 0.3);
        }

        .sidebar h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #a7b0d5;
        }

        .type-filter {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .type-item {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .type-item:hover {
            background: rgba(30, 40, 80, 0.5);
            border-color: #24315f;
        }

        .type-item.active {
            background: #1a274f;
            border-color: #263469;
            color: #a3c5ff;
        }

        .type-count {
            font-size: 12px;
            background: #24315f;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            /* å æ»¡å‰©ä½™é«˜åº¦ */
            overflow: hidden;
            /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        .table-container {
            background: linear-gradient(180deg, rgba(20, 30, 70, .3), rgba(10, 15, 35, .4));
            border: 1px solid #24315f;
            border-radius: 14px;
            overflow: hidden;
            /* éšè—å®¹å™¨æº¢å‡ºï¼Œè®©æ»šåŠ¨å®Œå…¨åœ¨table-wrapperå†… */
            width: 100%;
            height: calc(100% - 60px);
            /* å‡å»åˆ†é¡µå™¨é«˜åº¦(çº¦60px) */
            /* å›ºå®šé«˜åº¦ - ç¡®ä¿è¡¨æ ¼å§‹ç»ˆåœ¨è¿™ä¸ªé•¿æ–¹å½¢å†… */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            min-height: 350px;
            /* æœ€å°é«˜åº¦ç¡®ä¿è¡¨æ ¼åŒºåŸŸå¯è§ */
        }

        .table-header {
            background: #1a274f;
            padding: 12px 16px;
            border-bottom: 1px solid #24315f;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .table-wrapper {
            overflow: auto;
            /* å…è®¸æ¨ªå‘å’Œçºµå‘æ»šåŠ¨ */
            flex: 1;
            /* å æ»¡å‰©ä½™ç©ºé—´ */
            position: relative;
            background: transparent;
            width: 100%;
            height: 100%;
            max-height: 100%;
            /* ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨ */
            /* ç¡®ä¿æ»šåŠ¨æ¡åªåœ¨è¿™ä¸ªåŒºåŸŸå†…æ˜¾ç¤º */
            scrollbar-width: thin;
            /* Firefox */
            scrollbar-color: #24315f rgba(20, 30, 70, 0.3);
            /* Firefox */
        }

        .message-table {
            width: auto;
            /* è‡ªåŠ¨å®½åº¦ï¼Œæ ¹æ®å†…å®¹è°ƒæ•´ */
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
            table-layout: auto;
            /* æ”¹ä¸ºè‡ªåŠ¨å¸ƒå±€ï¼Œè®©è¡¨æ ¼æ ¹æ®å†…å®¹è°ƒæ•´åˆ—å®½ */
            min-width: 100%;
            /* è‡³å°‘å æ»¡å®¹å™¨å®½åº¦ */
            background: transparent;
            display: table !important;
        }

        .message-table thead {
            display: table-header-group !important;
        }

        .message-table tbody {
            display: table-row-group !important;
        }

        .message-table tr {
            display: table-row !important;
        }

        .message-table th,
        .message-table td {
            display: table-cell !important;
        }

        .table-title {
            font-weight: 600;
            font-size: 16px;
            flex: 1;
        }

        .message-table th {
            background: #141e46;
            color: #a7b0d5;
            font-weight: 500;
            padding: 8px 12px;
            /* å¢åŠ å·¦å³å†…è¾¹è·ç»™å­—æ®µåæ›´å¤šç©ºé—´ */
            text-align: left;
            border-bottom: 2px solid #24315f;
            border-right: 1px solid #24315f;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            /* ä¿æŒä¸æ¢è¡Œï¼Œè®©å­—æ®µåå®Œæ•´æ˜¾ç¤º */
            font-size: 12px;
            min-width: fit-content;
            /* æœ€å°å®½åº¦é€‚åº”å†…å®¹ */
        }

        .message-table th:first-child {
            width: 50px;
            /* å›ºå®šé€‰æ‹©æ¡†åˆ—å®½ */
            min-width: 50px;
            max-width: 50px;
            padding: 8px 6px;
            /* é€‰æ‹©æ¡†åˆ—ä¿æŒè¾ƒå°çš„å†…è¾¹è· */
        }

        .message-table td {
            padding: 6px 12px;
            /* å¢åŠ å·¦å³å†…è¾¹è·ç»™å†…å®¹æ›´å¤šç©ºé—´ */
            border-bottom: 1px solid rgba(36, 49, 95, 0.3);
            border-right: 1px solid rgba(36, 49, 95, 0.2);
            vertical-align: top;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
            min-width: fit-content;
            /* æœ€å°å®½åº¦é€‚åº”å†…å®¹ */
        }

        .message-table td:first-child {
            width: 50px;
            /* å›ºå®šé€‰æ‹©æ¡†åˆ—å®½ */
            min-width: 50px;
            max-width: 50px;
            text-align: center;
            padding: 6px;
            /* é€‰æ‹©æ¡†åˆ—ä¿æŒè¾ƒå°çš„å†…è¾¹è· */
        }

        .message-table tr:hover {
            background: rgba(30, 40, 80, 0.2);
        }

        .message-table tr.unread {
            border-left: 3px solid #4a9eff;
        }

        .message-table tr.read {
            opacity: 0.7;
        }

        .cell-content {
            word-break: break-word;
            white-space: nowrap;
            /* ä¸æ¢è¡Œï¼Œè¶…å‡ºéƒ¨åˆ†éšè— */
            overflow: hidden;
            text-overflow: ellipsis;
            /* æ˜¾ç¤ºçœç•¥å· */
            line-height: 1.4;
            max-width: 200px;
            /* è®¾ç½®ä¸€ä¸ªåˆç†çš„æœ€å¤§å®½åº¦ï¼Œè¶…å‡ºæ—¶æ˜¾ç¤ºçœç•¥å· */
            display: inline-block;
            /* ç¡®ä¿çœç•¥å·æ­£ç¡®æ˜¾ç¤º */
        }

        .cell-content.expanded {
            white-space: normal;
            /* å±•å¼€æ—¶å…è®¸æ¢è¡Œ */
            text-overflow: unset;
        }

        .cell-json {
            font-family: 'Courier New', monospace;
            background: rgba(20, 30, 70, 0.5);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-height: 60px;
        }

        .cell-expandable {
            cursor: pointer;
            position: relative;
        }

        .cell-expandable::after {
            content: "...";
            position: absolute;
            right: 0;
            bottom: 0;
            background: #0b1020;
            padding-left: 10px;
        }

        .cell-expandable.expanded::after {
            display: none;
        }

        .message-kind {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .kind-msg {
            background: #1a4b1a;
            color: #7bd87b;
        }

        .kind-notification {
            background: #1a3a4b;
            color: #7bb8d8;
        }

        .kind-alert {
            background: #4b1a1a;
            color: #d87b7b;
        }

        .kind-inapp {
            background: #3a3a1a;
            color: #d8d87b;
        }

        .kind-systemmaintenance {
            background: #4b3a1a;
            color: #d8b87b;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        header h1 {
            font-size: 20px;
            margin: 0 12px 0 0;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        input,
        select,
        button {
            background: #121a35;
            color: #e8ecff;
            border: 1px solid #24315f;
            padding: 8px 10px;
            border-radius: 10px;
        }

        button {
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #1a274f;
            border-color: #263469;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 12px 0;
        }

        .empty {
            opacity: .7;
            padding: 32px 0;
            text-align: center;
            grid-column: 1 / -1;
        }

        .pager {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            padding: 12px;
            background: rgba(20, 30, 70, 0.2);
            border-radius: 10px;
            flex-shrink: 0;
            /* é˜²æ­¢åˆ†é¡µå™¨è¢«å‹ç¼© */
        }

        .badge {
            padding: 2px 8px;
            border-radius: 999px;
            background: #1a274f;
            border: 1px solid #263469;
            font-size: 12px;
            color: #b8c3f5;
        }

        .loading {
            text-align: center;
            padding: 32px;
            opacity: 0.7;
        }

        .field-config {
            background: rgba(20, 30, 70, 0.3);
            border: 1px solid #24315f;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .field-config h4 {
            margin: 0 0 8px 0;
            color: #a7b0d5;
            font-size: 12px;
        }

        .field-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .field-tag {
            background: #24315f;
            color: #b8c3f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                gap: 12px;
            }

            .sidebar {
                width: 100%;
                max-height: 150px;
            }

            .table-container {
                height: calc(60vh - 60px);
                /* ä¸­ç­‰å±å¹•é€‚å½“å‡å°‘é«˜åº¦ï¼Œå‡å»åˆ†é¡µå™¨é«˜åº¦ */
                min-height: 300px;
            }

            .wrap {
                height: calc(100vh - 24px);
                /* è°ƒæ•´wrapé«˜åº¦ */
            }
        }

        @media (max-width: 768px) {
            .wrap {
                padding: 0 8px;
                margin: 12px 0;
                height: calc(100vh - 24px);
            }

            .main-container {
                height: calc(100% - 80px);
                /* ä¸ºheaderç•™å‡ºæ›´å¤šç©ºé—´ */
            }

            .table-container {
                height: calc(50vh - 60px);
                /* å°å±å¹•è¿›ä¸€æ­¥å‡å°‘é«˜åº¦ï¼Œå‡å»åˆ†é¡µå™¨é«˜åº¦ */
                min-height: 250px;
            }

            .message-table {
                font-size: 11px;
                /* ç§»é™¤å›ºå®šæœ€å°å®½åº¦é™åˆ¶ï¼Œè®©è¡¨æ ¼è‡ªé€‚åº” */
            }

            .message-table th,
            .message-table td {
                padding: 4px 3px;
                font-size: 10px;
            }

            .message-table th:first-child,
            .message-table td:first-child {
                width: 40px;
                min-width: 40px;
                max-width: 40px;
            }
        }

        /* è¡¨æ ¼æ€§èƒ½ä¼˜åŒ– */
        .message-table {
            table-layout: auto;
            /* æ”¹ä¸ºè‡ªåŠ¨å¸ƒå±€ç¡®ä¿è¡¨æ ¼å¯ä»¥æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
        }

        /* ç²˜æ€§è¡¨å¤´å¢å¼º */
        .message-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* æ»šåŠ¨æ€§èƒ½ä¼˜åŒ– */
        .table-wrapper {
            will-change: scroll-position;
            transform: translateZ(0);
            /* å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
        }

        /* ç¡®ä¿è¡¨æ ¼åœ¨å›ºå®šå®¹å™¨å†…æ­£å¸¸æ˜¾ç¤º */
        .table-wrapper {
            box-sizing: border-box;
        }

        .message-table th,
        .message-table td {
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <h1>ğŸ“¨ åŠ¨æ€æ¶ˆæ¯æ”¶ä»¶ç®±</h1>
            <div class="controls">
                <input type="text" id="userId" placeholder="ç”¨æˆ·ID" value="12345" />
                <select id="status">
                    <option value="all">æ‰€æœ‰</option>
                    <option value="unread">æœªè¯»</option>
                    <option value="read">å·²è¯»</option>
                </select>
                <select id="limit">
                    <option value="10">10æ¡/é¡µ</option>
                    <option value="20" selected>20æ¡/é¡µ</option>
                    <option value="50">50æ¡/é¡µ</option>
                </select>
                <button id="btnLoad">åŠ è½½</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <h3>æ¶ˆæ¯ç±»å‹</h3>
                <div class="type-filter" id="typeFilter">
                    <div class="type-item active" data-type="all">
                        <span>å…¨éƒ¨æ¶ˆæ¯</span>
                        <span class="type-count" id="count-all">0</span>
                    </div>
                </div>

                <div id="fieldConfig" style="margin-top: 20px;">
                    <h3>å­—æ®µé…ç½®</h3>
                    <div id="currentFieldConfig"></div>
                </div>
            </aside>

            <main class="content">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title" id="tableTitle">å…¨éƒ¨æ¶ˆæ¯</div>
                        <span class="badge" id="totalBadge">å…± 0 æ¡</span>
                        <div class="toolbar">
                            <span id="selectedHint" style="display:none">å·²é€‰ 0 æ¡</span>
                            <button id="btnMarkRead" disabled>æ ‡è®°å·²è¯»</button>
                            <button id="btnDelete" disabled>åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="message-table">
                            <thead id="messageTableHead">
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="selectAll" /></th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>ç±»å‹</th>
                                </tr>
                            </thead>
                            <tbody id="messageTableBody">
                            </tbody>
                        </table>
                        <div class="loading" id="loading" style="display:none;">åŠ è½½ä¸­...</div>
                        <div class="empty" id="empty" style="display:none;">æš‚æ— æ¶ˆæ¯</div>
                    </div>
                </div>

                <div class="pager" style="margin-top: 8px;">
                    <button id="prev" disabled>ä¸Šä¸€é¡µ</button>
                    <span id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
                    <button id="next" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        (function () {
            const qs = new URLSearchParams(location.search);
            const els = {
                userId: document.getElementById('userId'),
                status: document.getElementById('status'),
                limit: document.getElementById('limit'),
                btnLoad: document.getElementById('btnLoad'),
                btnMarkRead: document.getElementById('btnMarkRead'),
                btnDelete: document.getElementById('btnDelete'),
                selectedHint: document.getElementById('selectedHint'),
                messageTableHead: document.getElementById('messageTableHead'),
                messageTableBody: document.getElementById('messageTableBody'),
                empty: document.getElementById('empty'),
                loading: document.getElementById('loading'),
                totalBadge: document.getElementById('totalBadge'),
                prev: document.getElementById('prev'),
                next: document.getElementById('next'),
                pageInfo: document.getElementById('pageInfo'),
                tableTitle: document.getElementById('tableTitle'),
                typeFilter: document.getElementById('typeFilter'),
                currentFieldConfig: document.getElementById('currentFieldConfig'),
                selectAll: document.getElementById('selectAll'),
            };

            let state = {
                offset: 0,
                limit: parseInt(els.limit.value, 10) || 20,
                total: 0,
                selected: new Set(),
                currentType: 'all',
                allMessages: [],
                typeCounts: {},
                messageFormats: {}, // åŠ¨æ€æ¶ˆæ¯æ ¼å¼é…ç½®
                currentFields: [] // å½“å‰ç±»å‹çš„å­—æ®µé…ç½®
            };

            if (qs.get('user_id')) els.userId.value = qs.get('user_id');
            if (qs.get('status')) els.status.value = qs.get('status');            // å¢å¼ºçš„ fetchJson æ–¹æ³•ï¼Œæ›´å¥½çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•
            async function fetchJson(url, options = {}) {
                try {
                    console.log('å‘èµ·è¯·æ±‚:', url, options);

                    // ç¡®ä¿è®¾ç½®Acceptå¤´ä¸ºapplication/json
                    const headers = {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        ...(options.headers || {})
                    };

                    const requestOptions = {
                        ...options,
                        headers: headers
                    };

                    const resp = await fetch(url, requestOptions);
                    console.log('å“åº”çŠ¶æ€:', resp.status, resp.statusText);
                    console.log('å“åº”å¤´Content-Type:', resp.headers.get('Content-Type'));

                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    const contentType = resp.headers.get('Content-Type') || '';
                    const text = await resp.text(); // è·å–å®Œæ•´å“åº”å†…å®¹
                    console.log('å“åº”å†…å®¹é•¿åº¦:', text.length);
                    console.log('å“åº”å†…å®¹é¢„è§ˆ:', text.substring(0, 200));

                    if (!contentType.includes('application/json')) {
                        console.error('æœŸæœ›JSONä½†æ”¶åˆ°:', contentType);
                        console.error('å®Œæ•´å“åº”å†…å®¹:', text);
                        throw new Error(`æœåŠ¡å™¨è¿”å›äº†é JSON æ•°æ® (Content-Type: ${contentType})`);
                    }

                    try {
                        return JSON.parse(text);
                    } catch (parseError) {
                        console.error('JSONè§£æå¤±è´¥:', parseError);
                        console.error('å°è¯•è§£æçš„å†…å®¹:', text);
                        throw new Error(`JSONè§£æå¤±è´¥: ${parseError.message}`);
                    }
                } catch (e) {
                    console.error('è¯·æ±‚å¤±è´¥è¯¦æƒ…:', e);
                    console.error('è¯·æ±‚URL:', url);
                    console.error('è¯·æ±‚é€‰é¡¹:', options);

                    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
                    if (e.message.includes('Failed to fetch')) {
                        alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œåœ¨ http://localhost:8080');
                    } else {
                        alert('è¯·æ±‚å¤±è´¥ï¼š' + e.message);
                    }
                    throw e;
                }
            }

            // åŠ è½½æ¶ˆæ¯æ ¼å¼é…ç½®
            async function loadMessageFormats() {
                try {
                    console.log('å¼€å§‹åŠ è½½æ¶ˆæ¯æ ¼å¼é…ç½®...');
                    const data = await fetchJson('/dynamic-inbox/message-formats');
                    console.log('æ”¶åˆ°æ¶ˆæ¯æ ¼å¼æ•°æ®:', data);
                    console.log('æ¶ˆæ¯æ ¼å¼æ•°æ®è¯¦æƒ…:', JSON.stringify(data, null, 2));

                    // å¤„ç†æœåŠ¡ç«¯è¿”å›çš„æ•°æ®ç»“æ„
                    let formats = {};
                    if (data && data.data) {
                        formats = data.data;
                    } else if (data) {
                        formats = data;
                    }

                    console.log('å¤„ç†åçš„æ ¼å¼æ•°æ®:', formats);
                    console.log('æ ¼å¼æ•°æ®ç±»å‹:', typeof formats);
                    console.log('æ ¼å¼æ•°æ®é”®:', Object.keys(formats));

                    // ç¡®ä¿æ ¼å¼æ•°æ®æ˜¯å¯¹è±¡
                    if (typeof formats === 'object' && formats !== null) {
                        state.messageFormats = formats;
                        console.log('è®¾ç½®æ¶ˆæ¯æ ¼å¼çŠ¶æ€:', state.messageFormats);
                        console.log('æ¶ˆæ¯æ ¼å¼çŠ¶æ€è¯¦æƒ…:', JSON.stringify(state.messageFormats, null, 2));

                        updateTypeFilter();
                        updateFieldsForCurrentType();
                    } else {
                        console.warn('æ”¶åˆ°çš„æ ¼å¼æ•°æ®ä¸æ˜¯æœ‰æ•ˆå¯¹è±¡ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                        throw new Error('Invalid format data received');
                    }
                } catch (e) {
                    console.error('åŠ è½½æ¶ˆæ¯æ ¼å¼é…ç½®å¤±è´¥:', e);
                    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                    state.messageFormats = {
                        'Alert': {
                            Type: 'Alert',
                            Fields: [
                                { Name: 'subject', Type: 'string', Description: 'ä¸»é¢˜' },
                                { Name: 'body', Type: 'string', Description: 'å†…å®¹' }
                            ]
                        },
                        'Msg': {
                            Type: 'Msg',
                            Fields: [
                                { Name: 'subject', Type: 'string', Description: 'ä¸»é¢˜' },
                                { Name: 'body', Type: 'string', Description: 'å†…å®¹' }
                            ]
                        },
                        'Notification': {
                            Type: 'Notification',
                            Fields: [
                                { Name: 'subject', Type: 'string', Description: 'ä¸»é¢˜' },
                                { Name: 'body', Type: 'string', Description: 'å†…å®¹' }
                            ]
                        },
                        'SystemMaintenance': {
                            Type: 'SystemMaintenance',
                            Fields: [
                                { Name: 'maintenance_type', Type: 'string', Description: 'ç»´æŠ¤ç±»å‹' },
                                { Name: 'start_time', Type: 'string', Description: 'å¼€å§‹æ—¶é—´' },
                                { Name: 'end_time', Type: 'string', Description: 'ç»“æŸæ—¶é—´' },
                                { Name: 'description', Type: 'string', Description: 'æè¿°' }
                            ]
                        },
                        'OrderUpdate': {
                            Type: 'OrderUpdate',
                            Fields: [
                                { Name: 'order_id', Type: 'string', Description: 'è®¢å•ID' },
                                { Name: 'status', Type: 'string', Description: 'çŠ¶æ€' },
                                { Name: 'update_time', Type: 'string', Description: 'æ›´æ–°æ—¶é—´' }
                            ]
                        },
                        'AccountSecurity': {
                            Type: 'AccountSecurity',
                            Fields: [
                                { Name: 'security_type', Type: 'string', Description: 'å®‰å…¨äº‹ä»¶ç±»å‹' },
                                { Name: 'location', Type: 'string', Description: 'ä½ç½®' },
                                { Name: 'ip_address', Type: 'string', Description: 'IPåœ°å€' }
                            ]
                        }
                    };
                    console.log('ä½¿ç”¨é»˜è®¤æ¶ˆæ¯æ ¼å¼é…ç½®:', state.messageFormats);
                    updateTypeFilter();
                    updateFieldsForCurrentType();
                }
            }

            // æ›´æ–°ç±»å‹ç­›é€‰å™¨
            function updateTypeFilter() {
                console.log('æ›´æ–°ç±»å‹ç­›é€‰å™¨ï¼Œæ¶ˆæ¯æ ¼å¼:', state.messageFormats);
                const typeFilter = els.typeFilter;

                // æ¸…ç©ºå¹¶é‡å»ºæ‰€æœ‰é€‰é¡¹
                typeFilter.innerHTML = '';

                // åˆ›å»º"å…¨éƒ¨æ¶ˆæ¯"é¡¹
                const allItem = document.createElement('div');
                allItem.className = 'type-item active';
                allItem.dataset.type = 'all';
                allItem.innerHTML = `
                    <span>å…¨éƒ¨æ¶ˆæ¯</span>
                    <span class="type-count" id="count-all">0</span>
                `;
                typeFilter.appendChild(allItem);

                // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„æ¶ˆæ¯ç±»å‹ï¼ˆä»é…ç½®å’Œå®é™…æ¶ˆæ¯ä¸­ï¼‰
                const allTypes = new Set();

                // ä»æ¶ˆæ¯æ ¼å¼é…ç½®ä¸­æ·»åŠ ç±»å‹
                if (state.messageFormats && Object.keys(state.messageFormats).length > 0) {
                    Object.keys(state.messageFormats).forEach(type => {
                        allTypes.add(type);
                    });
                }

                // ä»å®é™…æ¶ˆæ¯æ•°æ®ä¸­æ”¶é›†ç±»å‹
                if (state.allMessages && state.allMessages.length > 0) {
                    state.allMessages.forEach(msg => {
                        if (msg.kind) {
                            allTypes.add(msg.kind);
                        }
                    });
                }

                // æ·»åŠ åŠ¨æ€æ¶ˆæ¯ç±»å‹
                allTypes.forEach(type => {
                    console.log('æ·»åŠ æ¶ˆæ¯ç±»å‹:', type);
                    const item = document.createElement('div');
                    item.className = 'type-item';
                    item.dataset.type = type;
                    item.innerHTML = `
                        <span>${getTypeDisplayName(type)}</span>
                        <span class="type-count" id="count-${type.toLowerCase()}">0</span>
                    `;
                    typeFilter.appendChild(item);
                });

                // ç¡®ä¿æœ‰ä¸€äº›é»˜è®¤çš„æ¶ˆæ¯ç±»å‹æ˜¾ç¤º
                if (allTypes.size === 0) {
                    const defaultTypes = ['Alert', 'Msg', 'Notification', 'SystemMaintenance', 'OrderUpdate', 'AccountSecurity'];
                    defaultTypes.forEach(type => {
                        const item = document.createElement('div');
                        item.className = 'type-item';
                        item.dataset.type = type;
                        item.innerHTML = `
                            <span>${getTypeDisplayName(type)}</span>
                            <span class="type-count" id="count-${type.toLowerCase()}">0</span>
                        `;
                        typeFilter.appendChild(item);
                    });
                }

                // åˆå§‹åŒ–è®¡æ•°
                updateTypeCounts();
            }

            // ç»‘å®šç±»å‹ç­›é€‰äº‹ä»¶ - åªç»‘å®šä¸€æ¬¡
            function bindTypeFilterEvents() {
                console.log('ç»‘å®šç±»å‹ç­›é€‰äº‹ä»¶');

                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const oldHandler = els.typeFilter._clickHandler;
                if (oldHandler) {
                    els.typeFilter.removeEventListener('click', oldHandler);
                }

                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å™¨
                const clickHandler = (e) => {
                    const item = e.target.closest('.type-item');
                    if (!item) return;

                    console.log('ç‚¹å‡»äº†ç±»å‹é¡¹:', item.dataset.type);

                    // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
                    document.querySelectorAll('.type-item').forEach(el => el.classList.remove('active'));
                    // è®¾ç½®å½“å‰é¡¹ä¸ºæ´»è·ƒ
                    item.classList.add('active');

                    // æ›´æ–°çŠ¶æ€
                    state.currentType = item.dataset.type;
                    state.offset = 0;

                    console.log('åˆ‡æ¢åˆ°ç±»å‹:', state.currentType);

                    // æ›´æ–°ç•Œé¢
                    updateTableTitle();
                    updateFieldsForCurrentType();
                    filterAndRender();
                };

                // ç»‘å®šæ–°çš„äº‹ä»¶å¤„ç†å™¨
                els.typeFilter.addEventListener('click', clickHandler);
                els.typeFilter._clickHandler = clickHandler; // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­ç§»é™¤
            }

            // è·å–ç±»å‹æ˜¾ç¤ºåç§°
            function getTypeDisplayName(type) {
                const displayNames = {
                    'Alert': 'âš ï¸ è­¦æŠ¥',
                    'alert': 'âš ï¸ è­¦æŠ¥',
                    'SystemMaintenance': 'ğŸ”§ ç³»ç»Ÿç»´æŠ¤',
                    'systemmaintenance': 'ğŸ”§ ç³»ç»Ÿç»´æŠ¤',
                    'system_maintenance': 'ğŸ”§ ç³»ç»Ÿç»´æŠ¤',
                    'OrderUpdate': 'ğŸ“¦ è®¢å•æ›´æ–°',
                    'orderupdate': 'ğŸ“¦ è®¢å•æ›´æ–°',
                    'order_update': 'ğŸ“¦ è®¢å•æ›´æ–°',
                    'AccountSecurity': 'ğŸ”’ è´¦æˆ·å®‰å…¨',
                    'accountsecurity': 'ğŸ”’ è´¦æˆ·å®‰å…¨',
                    'account_security': 'ğŸ”’ è´¦æˆ·å®‰å…¨',
                    'Msg': 'ğŸ’¬ æ¶ˆæ¯',
                    'msg': 'ğŸ’¬ æ¶ˆæ¯',
                    'message': 'ğŸ’¬ æ¶ˆæ¯',
                    'Message': 'ğŸ’¬ æ¶ˆæ¯',
                    'Notification': 'ğŸ”” é€šçŸ¥',
                    'notification': 'ğŸ”” é€šçŸ¥',
                    'InApp': 'ğŸ“± åº”ç”¨å†…æ¶ˆæ¯',
                    'inapp': 'ğŸ“± åº”ç”¨å†…æ¶ˆæ¯',
                    'in_app': 'ğŸ“± åº”ç”¨å†…æ¶ˆæ¯',
                    'unknown': 'â“ æœªçŸ¥ç±»å‹'
                };

                // é¦–å…ˆæŸ¥æ‰¾ç›´æ¥åŒ¹é…
                if (displayNames[type]) {
                    return displayNames[type];
                }

                // æŸ¥æ‰¾å°å†™åŒ¹é…
                const lowerType = type.toLowerCase();
                if (displayNames[lowerType]) {
                    return displayNames[lowerType];
                }

                // å°è¯•é©¼å³°å‘½åè½¬æ¢
                const camelCase = type.charAt(0).toUpperCase() + type.slice(1);
                if (displayNames[camelCase]) {
                    return displayNames[camelCase];
                }

                // å°è¯•ä¸‹åˆ’çº¿è½¬æ¢
                const snakeCase = type.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, '');
                if (displayNames[snakeCase]) {
                    return displayNames[snakeCase];
                }

                // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
                const emoji = getDefaultEmojiForType(type);
                const formatted = type.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                return `${emoji} ${formatted}`;
            }

            // ä¸ºæœªçŸ¥ç±»å‹è·å–é»˜è®¤emoji
            function getDefaultEmojiForType(type) {
                const lowerType = type.toLowerCase();
                if (lowerType.includes('alert') || lowerType.includes('warning')) return 'âš ï¸';
                if (lowerType.includes('security') || lowerType.includes('safe')) return 'ğŸ”’';
                if (lowerType.includes('order') || lowerType.includes('purchase')) return 'ğŸ“¦';
                if (lowerType.includes('maintenance') || lowerType.includes('system')) return 'ğŸ”§';
                if (lowerType.includes('message') || lowerType.includes('msg')) return 'ğŸ’¬';
                if (lowerType.includes('notification') || lowerType.includes('notify')) return 'ğŸ””';
                if (lowerType.includes('app') || lowerType.includes('mobile')) return 'ğŸ“±';
                return 'ğŸ“„';
            }
            function resolveFormatKey(type) {
                if (!state.messageFormats) return type;
                if (state.messageFormats[type]) return type;
                const lc = String(type || '').toLowerCase();
                const hit = Object.keys(state.messageFormats).find(k => k.toLowerCase() === lc);
                return hit || type;
            }

            // æ›´æ–°å½“å‰ç±»å‹çš„å­—æ®µé…ç½®
            function updateFieldsForCurrentType() {
                const currentType = resolveFormatKey(state.currentType);
                console.log('æ›´æ–°å­—æ®µé…ç½®ï¼Œå½“å‰ç±»å‹:', currentType);

                if (currentType === 'all') {
                    state.currentFields = [
                        { name: 'created_at', label: 'åˆ›å»ºæ—¶é—´', type: 'datetime' },
                        { name: 'read_at', label: 'çŠ¶æ€', type: 'status' },
                        { name: 'kind', label: 'ç±»å‹', type: 'kind' },
                        { name: 'subject', label: 'ä¸»é¢˜', type: 'string' },
                        { name: 'body', label: 'å†…å®¹', type: 'string' }
                    ];
                } else {
                    // è·å–ç‰¹å®šç±»å‹çš„å­—æ®µé…ç½®
                    const typeConfig = findMessageFormatByType(currentType);
                    console.log('è·å–åˆ°çš„ç±»å‹é…ç½®:', typeConfig);

                    if (typeConfig && Array.isArray(typeConfig) && typeConfig.length > 0) {
                        state.currentFields = [
                            { name: 'created_at', label: 'åˆ›å»ºæ—¶é—´', type: 'datetime' },
                            { name: 'read_at', label: 'çŠ¶æ€', type: 'status' },
                            { name: 'kind', label: 'ç±»å‹', type: 'kind' },
                            ...typeConfig.map(field => ({
                                name: field.Name || field.name || 'unknown',
                                label: field.Description || field.description || field.label || field.Label || field.Name || field.name || 'Unknown',
                                type: field.Type || field.type || 'string'
                            }))
                        ];
                    } else {
                        console.log('ä½¿ç”¨é€šç”¨å­—æ®µé…ç½®ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆæ¯ç±»å‹éƒ½èƒ½æ˜¾ç¤º');
                        // å¢å¼ºçš„é»˜è®¤å­—æ®µé…ç½®ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆæ¯ç±»å‹éƒ½èƒ½åœ¨è¡¨æ ¼ä¸­æ­£å¸¸æ˜¾ç¤º
                        state.currentFields = [
                            { name: 'created_at', label: 'åˆ›å»ºæ—¶é—´', type: 'datetime' },
                            { name: 'read_at', label: 'çŠ¶æ€', type: 'status' },
                            { name: 'kind', label: 'ç±»å‹', type: 'kind' },
                            { name: 'subject', label: 'ä¸»é¢˜', type: 'string' },
                            { name: 'body', label: 'å†…å®¹', type: 'string' },
                            { name: 'data', label: 'æ¶ˆæ¯æ•°æ®', type: 'object' }  // æ·»åŠ dataå­—æ®µæ¥æ˜¾ç¤ºåŠ¨æ€å†…å®¹
                        ];
                    }
                }

                console.log('æœ€ç»ˆå­—æ®µé…ç½®:', state.currentFields);
                updateTableHeader();
                updateFieldConfigDisplay();
            }            // æŸ¥æ‰¾æ¶ˆæ¯æ ¼å¼é…ç½®
            function findMessageFormatByType(type) {
                console.log('æŸ¥æ‰¾æ¶ˆæ¯æ ¼å¼é…ç½®ï¼Œç±»å‹:', type, 'å¯ç”¨æ ¼å¼:', Object.keys(state.messageFormats));

                // å¦‚æœæ²¡æœ‰æ ¼å¼é…ç½®æ•°æ®ï¼Œè¿”å›nullè®©ç³»ç»Ÿä½¿ç”¨é»˜è®¤é…ç½®
                if (!state.messageFormats || Object.keys(state.messageFormats).length === 0) {
                    console.log('æ²¡æœ‰æ¶ˆæ¯æ ¼å¼é…ç½®æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                    return null;
                }

                // å°è¯•ä¸åŒçš„ç±»å‹åç§°åŒ¹é…
                const possibleKeys = [
                    type,
                    type.charAt(0).toUpperCase() + type.slice(1),
                    type.toLowerCase(),
                    type.toUpperCase()
                ];

                for (const key of possibleKeys) {
                    if (state.messageFormats[key]) {
                        console.log('æ‰¾åˆ°åŒ¹é…æ ¼å¼:', key, state.messageFormats[key]);

                        const format = state.messageFormats[key];

                        // è¯¦ç»†è°ƒè¯•å¯¹è±¡ç»“æ„
                        console.log('æ ¼å¼å¯¹è±¡ç±»å‹:', typeof format);
                        console.log('æ ¼å¼å¯¹è±¡è¯¦æƒ…:', JSON.stringify(format, null, 2));

                        // æƒ…å†µ1ï¼šåŒ…å«Fieldsæ•°ç»„çš„å¯¹è±¡ï¼Œæ”¯æŒå¤§å°å†™ {Type: "xxx", Fields: [...]} æˆ– {type: "xxx", fields: [...]}
                        const fieldsArray = format.Fields || format.fields;
                        console.log('æŸ¥æ‰¾Fields/fields:', 'Fieldså­˜åœ¨:', !!format.Fields, 'fieldså­˜åœ¨:', !!format.fields);
                        console.log('fieldsArray:', fieldsArray);

                        if (fieldsArray && Array.isArray(fieldsArray) && fieldsArray.length > 0) {
                            console.log('ä½¿ç”¨Fields/fieldsæ•°ç»„:', fieldsArray);
                            return fieldsArray;
                        }

                        // æƒ…å†µ2ï¼šç›´æ¥æ˜¯å­—æ®µæ•°ç»„ [{name, type, label}, ...]
                        if (Array.isArray(format) && format.length > 0) {
                            console.log('ä½¿ç”¨å­—æ®µæ•°ç»„:', format);
                            return format;
                        }

                        // æƒ…å†µ3ï¼šæ˜¯å¯¹è±¡ï¼Œä½†å¯èƒ½æœ‰å…¶ä»–ç»“æ„
                        if (typeof format === 'object' && format !== null) {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å•ä¸€æ¶ˆæ¯æ ¼å¼å¯¹è±¡ï¼ŒåŒ…å«å­—æ®µä¿¡æ¯
                            const keys = Object.keys(format);
                            console.log('å¯¹è±¡å±æ€§:', keys);

                            // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„å­—æ®µå±æ€§
                            const possibleFieldKeys = ['Fields', 'fields', 'Field', 'field'];
                            for (const fieldKey of possibleFieldKeys) {
                                if (format[fieldKey] && Array.isArray(format[fieldKey]) && format[fieldKey].length > 0) {
                                    console.log(`æ‰¾åˆ°å­—æ®µæ•°ç»„ ${fieldKey}:`, format[fieldKey]);
                                    return format[fieldKey];
                                }
                            }

                            // å¦‚æœæœ‰Typeæˆ–typeå±æ€§ï¼Œå¯èƒ½æ˜¯MessageFormatç»“æ„
                            if (format.Type || format.type) {
                                console.log('æ‰¾åˆ°Type/typeä½†æ²¡æœ‰å¯è¯†åˆ«çš„å­—æ®µæ•°ç»„');
                                console.log('å®Œæ•´æ ¼å¼å¯¹è±¡:', format);
                                // ä¸ç«‹å³è¿”å›ç©ºæ•°ç»„ï¼Œç»§ç»­æ£€æŸ¥å…¶ä»–å¯èƒ½æ€§
                            }

                            // æ£€æŸ¥æ˜¯å¦ç›´æ¥åŒ…å«å­—æ®µä¿¡æ¯
                            const hasFieldLikeProperties = keys.some(key =>
                                ['name', 'type', 'description', 'required'].includes(key.toLowerCase())
                            );
                            if (hasFieldLikeProperties) {
                                console.log('å¯¹è±¡æœ¬èº«ä¼¼ä¹å°±æ˜¯ä¸€ä¸ªå­—æ®µå®šä¹‰');
                                return [format];
                            }

                            // æ£€æŸ¥å¯¹è±¡çš„å±æ€§æ˜¯å¦å¯ä»¥ä½œä¸ºå­—æ®µå±•ç¤º
                            if (keys.length > 0) {
                                console.log('å°†å¯¹è±¡å±æ€§è½¬æ¢ä¸ºå­—æ®µé…ç½®');
                                return keys.map(key => ({
                                    name: key,
                                    label: key.charAt(0).toUpperCase() + key.slice(1),
                                    type: typeof format[key] === 'object' ? 'object' : 'string'
                                }));
                            }
                        }

                        console.log('æ— æ³•è¯†åˆ«çš„æ ¼å¼ç»“æ„ï¼Œè¿”å›åŸå§‹æ•°æ®:', format);
                        // å¦‚æœæ— æ³•è¯†åˆ«æ ¼å¼ï¼Œè¿”å›nullè®©ç³»ç»Ÿä½¿ç”¨é»˜è®¤é…ç½®
                        return null;
                    }
                }
                console.log('æœªæ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯æ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                return null;
            }

            // æ›´æ–°è¡¨å¤´
            function updateTableHeader() {
                const thead = els.messageTableHead;
                thead.innerHTML = '';

                const headerRow = document.createElement('tr');

                // é€‰æ‹©æ¡†åˆ—
                const checkboxTh = document.createElement('th');
                checkboxTh.style.width = '50px';
                checkboxTh.style.minWidth = '50px';
                checkboxTh.style.maxWidth = '50px';
                checkboxTh.innerHTML = '<input type="checkbox" id="selectAllNew" />';
                headerRow.appendChild(checkboxTh);

                // åŠ¨æ€å­—æ®µåˆ— - è®©æ¯åˆ—è‡ªé€‚åº”å†…å®¹å®½åº¦
                state.currentFields.forEach((field, index) => {
                    const th = document.createElement('th');
                    th.textContent = field.label;

                    // ç§»é™¤å›ºå®šå®½åº¦é™åˆ¶ï¼Œè®©è¡¨æ ¼è‡ªé€‚åº”å†…å®¹
                    th.style.minWidth = getMinColumnWidth(field.type); // è®¾ç½®æœ€å°å®½åº¦
                    th.style.whiteSpace = 'nowrap'; // ç¡®ä¿å­—æ®µåä¸æ¢è¡Œ

                    headerRow.appendChild(th);
                });

                thead.appendChild(headerRow);

                // é‡æ–°ç»‘å®šå…¨é€‰äº‹ä»¶
                const selectAllNew = thead.querySelector('#selectAllNew');
                if (selectAllNew) {
                    selectAllNew.addEventListener('change', (e) => {
                        const checked = e.target.checked;
                        const checkboxes = els.messageTableBody.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            cb.checked = checked;
                            const id = cb.dataset.id;
                            if (checked) {
                                state.selected.add(id);
                            } else {
                                state.selected.delete(id);
                            }
                        });
                        updateSelectionHint();
                    });
                }
            }

            // è·å–æœ€å°åˆ—å®½ - ç¡®ä¿å­—æ®µåå’Œå†…å®¹éƒ½èƒ½å®Œæ•´æ˜¾ç¤º
            function getMinColumnWidth(type) {
                // ä¸ºä¸åŒç±»å‹çš„åˆ—è®¾ç½®åˆé€‚çš„æœ€å°å®½åº¦
                const widths = {
                    'datetime': '160px',    // æ—¥æœŸæ—¶é—´éœ€è¦æ›´å¤šç©ºé—´
                    'status': '80px',       // çŠ¶æ€åˆ—é€‚ä¸­
                    'kind': '120px',        // ç±»å‹åˆ—æ˜¾ç¤ºå¾½ç« éœ€è¦ç©ºé—´
                    'string': '150px',      // å­—ç¬¦ä¸²ç±»å‹é»˜è®¤å®½åº¦
                    'int': '100px',         // æ•°å­—ç±»å‹
                    'uint64': '120px',      // é•¿æ•´å‹
                    '[]uint64': '150px',    // æ•°ç»„ç±»å‹
                    '[]string': '180px',    // å­—ç¬¦ä¸²æ•°ç»„
                    'object': '200px'       // å¯¹è±¡ç±»å‹éœ€è¦æ›´å¤šç©ºé—´
                };
                return widths[type] || '120px'; // é»˜è®¤æœ€å°å®½åº¦
            }

            // è·å–åˆ—å®½ - ä¿ç•™åŸå‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨
            function getColumnWidth(type) {
                return getMinColumnWidth(type);
            }

            // æ›´æ–°å­—æ®µé…ç½®æ˜¾ç¤º
            function updateFieldConfigDisplay() {
                const container = els.currentFieldConfig;
                container.innerHTML = '';

                if (state.currentType === 'all') {
                    container.innerHTML = '<p style="opacity:0.7;font-size:12px;">æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ç±»å‹çš„é€šç”¨å­—æ®µ</p>';
                    return;
                }

                const config = findMessageFormatByType(resolveFormatKey(state.currentType));
                console.log('å­—æ®µé…ç½®æ˜¾ç¤ºï¼Œç±»å‹:', state.currentType, 'é…ç½®:', config);

                if (!config || !Array.isArray(config)) {
                    container.innerHTML = '<p style="opacity:0.7;font-size:12px;">è¯¥ç±»å‹æš‚æ— å­—æ®µé…ç½®</p>';
                    return;
                }

                const fieldConfigDiv = document.createElement('div');
                fieldConfigDiv.className = 'field-config';
                fieldConfigDiv.innerHTML = `
                    <h4>${getTypeDisplayName(state.currentType)} å­—æ®µ</h4>
                    <div class="field-tags">
                        ${config.map(field => {
                    const name = field.Name || field.name || 'æœªçŸ¥å­—æ®µ';
                    const type = field.Type || field.type || 'æœªçŸ¥ç±»å‹';
                    const label = field.Description || field.description || field.label || field.Label || name;
                    return `<span class="field-tag">${label} (${type})</span>`;
                }).join('')}
                    </div>
                `;
                container.appendChild(fieldConfigDiv);
            }

            // æ›´æ–°ç»Ÿè®¡è®¡æ•°
            function updateTypeCounts() {
                // é‡ç½®è®¡æ•°
                state.typeCounts = { all: 0 };

                // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„ç±»å‹
                const allTypes = new Set();

                // ä»æ¶ˆæ¯æ ¼å¼é…ç½®ä¸­æ·»åŠ ç±»å‹
                if (state.messageFormats) {
                    Object.keys(state.messageFormats).forEach(type => {
                        allTypes.add(type);
                        state.typeCounts[type.toLowerCase()] = 0;
                    });
                }

                // ä»å®é™…æ¶ˆæ¯ä¸­æ”¶é›†ç±»å‹å¹¶åˆå§‹åŒ–è®¡æ•°
                if (state.allMessages) {
                    state.allMessages.forEach(msg => {
                        if (msg.kind) {
                            allTypes.add(msg.kind);
                            const lowerKind = msg.kind.toLowerCase();
                            if (state.typeCounts[lowerKind] === undefined) {
                                state.typeCounts[lowerKind] = 0;
                            }
                        }
                    });
                }

                // ç»Ÿè®¡å„ç±»å‹æ¶ˆæ¯æ•°é‡
                if (state.allMessages) {
                    state.allMessages.forEach(msg => {
                        state.typeCounts.all++;
                        if (msg.kind) {
                            const lowerKind = msg.kind.toLowerCase();
                            state.typeCounts[lowerKind]++;
                        } else {
                            // å¤„ç†æ²¡æœ‰kindå­—æ®µçš„æ¶ˆæ¯
                            if (state.typeCounts.unknown === undefined) {
                                state.typeCounts.unknown = 0;
                            }
                            state.typeCounts.unknown++;
                        }
                    });
                }

                // æ›´æ–°æ˜¾ç¤º
                Object.keys(state.typeCounts).forEach(type => {
                    const el = document.getElementById(`count-${type}`);
                    if (el) el.textContent = state.typeCounts[type];
                });

                console.log('æ›´æ–°åçš„ç±»å‹è®¡æ•°:', state.typeCounts);
            }

            // è·å–è¿‡æ»¤åçš„æ¶ˆæ¯
            function getFilteredMessages() {
                if (state.currentType === 'all') {
                    return state.allMessages || [];
                }

                console.log('ç­›é€‰æ¶ˆæ¯ï¼Œå½“å‰ç±»å‹:', state.currentType, 'æ‰€æœ‰æ¶ˆæ¯æ•°:', (state.allMessages || []).length);

                const filtered = (state.allMessages || []).filter(msg => {
                    if (!msg.kind) {
                        // å¦‚æœæ¶ˆæ¯æ²¡æœ‰kindå­—æ®µï¼Œåªæœ‰åœ¨ç­›é€‰'unknown'ç±»å‹æ—¶æ‰æ˜¾ç¤º
                        return state.currentType.toLowerCase() === 'unknown';
                    }

                    const msgKind = msg.kind.toLowerCase();
                    const targetType = state.currentType.toLowerCase();

                    // ç›´æ¥åŒ¹é…
                    if (msgKind === targetType) return true;

                    // å°è¯•æ›´çµæ´»çš„åŒ¹é…
                    const possibleMatches = [
                        targetType,
                        targetType.charAt(0).toUpperCase() + targetType.slice(1),
                        targetType.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, ''),
                        // æ·»åŠ æ›´å¤šåŒ¹é…æ¨¡å¼
                        targetType.replace(/_/g, ''),
                        targetType.replace(/([a-z])([A-Z])/g, '$1_$2').toLowerCase()
                    ];

                    const isMatch = possibleMatches.some(match => {
                        return msgKind === match.toLowerCase() ||
                            msg.kind === match ||
                            msg.kind.toLowerCase() === match.toLowerCase();
                    });

                    return isMatch;
                });

                console.log('ç­›é€‰ç»“æœ:', filtered.length, 'æ¡æ¶ˆæ¯');
                return filtered;
            }

            // æ ¼å¼åŒ–å•å…ƒæ ¼å†…å®¹
            function formatCellContent(value, field) {
                if (value === null || value === undefined) {
                    return '<span style="opacity:0.5">-</span>';
                }

                const contentId = `content_${Math.random().toString(36).substr(2, 9)}`;

                switch (field.type) {
                    case 'datetime':
                        return `<span title="${new Date(value * 1000).toLocaleString()}">${new Date(value * 1000).toLocaleString()}</span>`;
                    case 'status':
                        return value > 0 ?
                            '<span style="color:#7bd87b" title="å·²è¯»">å·²è¯»</span>' :
                            '<span style="color:#d87b7b" title="æœªè¯»">æœªè¯»</span>';
                    case 'kind':
                        return getKindBadge(value);
                    case 'object':
                        const jsonStr = JSON.stringify(value, null, 2);
                        return `<span title="${jsonStr}" class="cell-content" style="cursor:pointer" onclick="alert('${jsonStr.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">${jsonStr.length > 50 ? jsonStr.substring(0, 50) + '...' : jsonStr}</span>`;
                    case '[]uint64':
                    case '[]string':
                        if (Array.isArray(value)) {
                            const content = `[${value.join(', ')}]`;
                            return `<span title="${content}" class="cell-content">${content.length > 30 ? content.substring(0, 30) + '...' : content}</span>`;
                        }
                        return `<span class="cell-content">${value}</span>`;
                    default:
                        const stringValue = String(value);
                        return `<span title="${stringValue}" class="cell-content">${stringValue.length > 50 ? stringValue.substring(0, 50) + '...' : stringValue}</span>`;
                }
            }

            // è·å–å•å…ƒæ ¼å€¼
            function getCellValue(msg, fieldName) {
                console.log('è·å–å•å…ƒæ ¼å€¼ï¼Œå­—æ®µ:', fieldName, 'æ¶ˆæ¯:', msg);

                // å¤„ç†åŸºç¡€å­—æ®µ
                switch (fieldName) {
                    case 'created_at':
                        return msg.created_at;
                    case 'read_at':
                        return msg.read_at;
                    case 'kind':
                        return msg.kind;
                    case 'subject':
                        return msg.subject;
                    case 'body':
                        return msg.body;
                    case 'data':
                        // ç‰¹æ®Šå¤„ç†dataå­—æ®µï¼Œå°†å…¶ä½œä¸ºå¯¹è±¡æ˜¾ç¤º
                        return msg.data || {};
                    default:
                        // é¦–å…ˆä»dataå­—æ®µä¸­æŸ¥æ‰¾
                        if (msg.data && typeof msg.data === 'object' && msg.data[fieldName] !== undefined) {
                            console.log('ä»dataå­—æ®µæ‰¾åˆ°å€¼:', fieldName, msg.data[fieldName]);
                            return msg.data[fieldName];
                        }

                        // ç„¶åä»æ¶ˆæ¯æœ¬èº«æŸ¥æ‰¾
                        if (msg[fieldName] !== undefined) {
                            console.log('ä»æ¶ˆæ¯æœ¬èº«æ‰¾åˆ°å€¼:', fieldName, msg[fieldName]);
                            return msg[fieldName];
                        }

                        // å°è¯•å¤§å°å†™å˜æ¢å’Œå¸¸è§å­—æ®µåå˜ä½“
                        const variations = [
                            fieldName.toLowerCase(),
                            fieldName.charAt(0).toUpperCase() + fieldName.slice(1),
                            fieldName.toUpperCase(),
                            // æ·»åŠ å¸¸è§çš„å­—æ®µåå˜ä½“
                            fieldName.replace(/([A-Z])/g, '_$1').toLowerCase(),
                            fieldName.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase())
                        ];

                        for (const variation of variations) {
                            if (msg.data && typeof msg.data === 'object' && msg.data[variation] !== undefined) {
                                console.log('ä»dataå­—æ®µæ‰¾åˆ°å˜ä½“å€¼:', variation, msg.data[variation]);
                                return msg.data[variation];
                            }
                            if (msg[variation] !== undefined) {
                                console.log('ä»æ¶ˆæ¯æœ¬èº«æ‰¾åˆ°å˜ä½“å€¼:', variation, msg[variation]);
                                return msg[variation];
                            }
                        }

                        // å¦‚æœæ˜¯å¯¹è±¡ç±»å‹ä¸”æ‰¾ä¸åˆ°å…·ä½“å­—æ®µï¼Œå°è¯•è¿”å›æ•´ä¸ªdataå¯¹è±¡
                        if (fieldName === 'data' || fieldName.includes('data')) {
                            return msg.data || {};
                        }

                        console.log('æœªæ‰¾åˆ°å­—æ®µå€¼:', fieldName);
                        return undefined;
                }
            }

            // è·å–ç±»å‹å¾½ç« 
            function getKindBadge(kind) {
                const safeKind = (kind || 'unknown').toLowerCase();
                return `<span class="message-kind kind-${safeKind}">${kind || 'Unknown'}</span>`;
            }

            // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
            function render() {
                const filteredMessages = getFilteredMessages();
                const startIndex = state.offset;
                const endIndex = Math.min(startIndex + state.limit, filteredMessages.length);
                const pageMessages = filteredMessages.slice(startIndex, endIndex);

                console.log('æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨:', {
                    currentType: state.currentType,
                    filteredCount: filteredMessages.length,
                    pageCount: pageMessages.length,
                    currentFields: state.currentFields
                });

                els.messageTableBody.innerHTML = '';

                if (pageMessages.length === 0) {
                    els.empty.style.display = '';
                    return;
                }
                els.empty.style.display = 'none';

                pageMessages.forEach((msg, index) => {
                    console.log(`æ¸²æŸ“ç¬¬${index + 1}æ¡æ¶ˆæ¯:`, msg);

                    const row = document.createElement('tr');
                    row.className = msg.read_at > 0 ? 'read' : 'unread';

                    // é€‰æ‹©æ¡†
                    let rowHTML = `<td><input type="checkbox" data-id="${msg.id}" /></td>`;

                    // æ ¹æ®å½“å‰å­—æ®µé…ç½®åŠ¨æ€æ¸²æŸ“
                    state.currentFields.forEach(field => {
                        const cellValue = getCellValue(msg, field.name);
                        const formattedContent = formatCellContent(cellValue, field);
                        rowHTML += `<td>${formattedContent}</td>`;
                        console.log(`å­—æ®µ ${field.name}:`, cellValue, '->', formattedContent);
                    });

                    row.innerHTML = rowHTML;
                    els.messageTableBody.appendChild(row);
                });

                // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
                els.messageTableBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        if (e.target.checked) {
                            state.selected.add(id);
                        } else {
                            state.selected.delete(id);
                        }
                        updateSelectionHint();
                    });
                });
            }

            // æ›´æ–°é€‰æ‹©æç¤º
            function updateSelectionHint() {
                const n = state.selected.size;
                els.btnMarkRead.disabled = n === 0;
                els.btnDelete.disabled = n === 0;
                els.selectedHint.style.display = n ? '' : 'none';
                els.selectedHint.textContent = `å·²é€‰ ${n} æ¡`;
            }

            // æ›´æ–°è¡¨æ ¼æ ‡é¢˜
            function updateTableTitle() {
                const title = state.currentType === 'all' ? 'å…¨éƒ¨æ¶ˆæ¯' : getTypeDisplayName(state.currentType);
                els.tableTitle.textContent = title;
            }

            // è¿‡æ»¤å’Œæ¸²æŸ“
            function filterAndRender() {
                const filteredMessages = getFilteredMessages();
                const totalFiltered = filteredMessages.length;

                render();

                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                const page = Math.floor(state.offset / state.limit) + 1;
                const totalPages = Math.max(1, Math.ceil(totalFiltered / state.limit));
                els.pageInfo.textContent = `ç¬¬ ${page} / ${totalPages} é¡µ`;

                els.prev.disabled = state.offset <= 0;
                els.next.disabled = state.offset + state.limit >= totalFiltered;

                state.selected.clear();
                updateSelectionHint();
            }

            // åŠ è½½æ¶ˆæ¯æ•°æ®
            async function loadMessages() {
                const user_id = els.userId.value.trim();
                if (!user_id) return alert('è¯·å¡«å†™ç”¨æˆ·ID');

                els.loading.style.display = '';
                els.empty.style.display = 'none';

                const status = els.status.value;
                const url = `/dynamic-inbox?user_id=${encodeURIComponent(user_id)}&status=${encodeURIComponent(status)}&offset=0&limit=1000`;

                try {
                    const data = await fetchJson(url);
                    state.allMessages = data.data || [];
                    state.total = data.total || 0;
                    state.offset = 0;

                    updateTypeCounts();
                    els.totalBadge.textContent = `å…± ${state.total} æ¡`;

                    filterAndRender();
                } catch (e) {
                    console.error(e);
                    alert('åŠ è½½å¤±è´¥ï¼š' + e.message);
                } finally {
                    els.loading.style.display = 'none';
                }
            }

            // äº‹ä»¶ç›‘å¬å™¨
            els.limit.addEventListener('change', () => {
                state.limit = parseInt(els.limit.value, 10) || 20;
                state.offset = 0;
                filterAndRender();
            });

            els.btnLoad.addEventListener('click', loadMessages);

            els.prev.addEventListener('click', () => {
                state.offset = Math.max(0, state.offset - state.limit);
                filterAndRender();
            });

            els.next.addEventListener('click', () => {
                if (state.offset + state.limit < getFilteredMessages().length) {
                    state.offset += state.limit;
                    filterAndRender();
                }
            });

            // æ ‡è®°å·²è¯»
            els.btnMarkRead.addEventListener('click', async () => {
                if (state.selected.size === 0) return;
                const user_id = els.userId.value.trim();
                const ids = Array.from(state.selected);
                try {
                    await fetchJson('/dynamic-inbox/mark_read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id, ids }),
                    });
                    state.selected.clear();
                    updateSelectionHint();
                    await loadMessages();
                } catch (e) {
                    alert('æ ‡è®°å¤±è´¥ï¼š' + e.message);
                }
            });

            // åˆ é™¤æ¶ˆæ¯
            els.btnDelete.addEventListener('click', async () => {
                if (state.selected.size === 0) return;
                if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${state.selected.size} æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;

                const user_id = els.userId.value.trim();
                const ids = Array.from(state.selected);
                try {
                    await fetchJson('/dynamic-inbox/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id, ids }),
                    });
                    state.selected.clear();
                    updateSelectionHint();
                    await loadMessages();
                } catch (e) {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
                }
            });

            // åˆå§‹åŒ–
            async function init() {
                console.log('å¼€å§‹åˆå§‹åŒ–...');

                // å…ˆç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿ç‚¹å‡»èƒ½æ­£å¸¸å·¥ä½œ
                bindTypeFilterEvents();

                console.log('æ­£åœ¨åŠ è½½æ¶ˆæ¯æ ¼å¼...');
                await loadMessageFormats();

                console.log('å½“å‰æ¶ˆæ¯æ ¼å¼çŠ¶æ€:', state.messageFormats);
                console.log('å¯ç”¨çš„æ¶ˆæ¯æ ¼å¼é”®:', Object.keys(state.messageFormats));

                updateTableTitle();
                updateFieldsForCurrentType();

                if (els.userId.value.trim()) {
                    console.log('è‡ªåŠ¨åŠ è½½ç”¨æˆ·æ¶ˆæ¯...');
                    await loadMessages();
                }

                console.log('åˆå§‹åŒ–å®Œæˆ');
            }

            init();
        })();
    </script>
</body>

</html>